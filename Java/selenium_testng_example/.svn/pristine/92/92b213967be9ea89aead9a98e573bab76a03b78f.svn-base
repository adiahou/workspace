package dxy.vs.pages;

import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertTrue;

import java.util.List;

import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.FindBy;
import org.openqa.selenium.support.PageFactory;

import dxy.vs.base.SetUp;

public class OpsDetail_CommentPage extends SetUp{
	
	//评论详情表
	@FindBy(xpath="//dl[@class='vertical-list']")
	public WebElement form_commentFields;
	
	//评论详情页所有field
	@FindBy(xpath="//dl[@class='vertical-list']/dt")
	public List<WebElement> commentFields;
	
	//回复评论输入框
	@FindBy(xpath=".//*[text()='回复评论']")
	public WebElement text_replay;
	
	//所有回复
	@FindBy(xpath=".//*[text()='所有回复']")
	public WebElement text_AllReplay;
	
	//Initialize Pages
	OpsDataPage opsDataPage;
	

	public void verifyDetail_DeletedComment() throws Exception {
		
		opsDataPage = PageFactory.initElements(threadDriver.get(), OpsDataPage.class);
		
		//过滤评论
		opsDataPage.filterOps_type("类型","评论");
		
		//查找所要状态评论所在列
		String statusColumnNo = getNodeNo(opsDataPage.titles,"状态");
		List<WebElement> statusValue;
		boolean isNextExist = false;
		boolean isFind = false;
		String deleteRowNo = null;
		
		do{
			if(isElementExist(opsDataPage.li_next)){
					isNextExist = !isElementDisabled(opsDataPage.li_next);
			}else{
					isNextExist = false;
			}

			statusValue = driver.findElements(By.xpath(".//*[@id='opdata-list']/tbody/tr/td["+statusColumnNo+"]"));
			for(int i=0;i<statusValue.size();i++){
					if(statusValue.get(i).getText().contains("已删除")){
						deleteRowNo = Integer.toString(i+1);
						isFind = true;
						break;}
					}
				
			if(!isFind){
				if(isNextExist){
					opsDataPage.btn_next.click();
					waitForPageLoadComplete();
					}else{
						System.out.println("没有找到状态为已删除的评论。");
					}
				}
		}while(isNextExist&&!isFind);
		
		if(isFind){
			String viewColumnNo = getNodeNo(opsDataPage.titles,"管理");
			List<WebElement> link_ComDetail = driver.findElements(By.xpath(".//*[@id='opdata-list']/tbody/tr["+deleteRowNo+"]/td["+viewColumnNo+"]"));
			
			//点击浏览链接
			link_ComDetail.get(0).click();
			waitForPageLoadComplete();
			waitForElementExist(form_commentFields);
			
			//验证状态是否正确
			String statusNo = getNodeNo(commentFields,"状态");
			WebElement statusValueIndetail = driver.findElement(By.xpath("//dl[@class='vertical-list']/dd["+statusNo+"]"));
			assertTrue("评论详情页已删除状态不正确", statusValueIndetail.getText().contains("已删除"));
			
			//验证回复框不显示
			assertFalse("评论框显示在已删除评论页中。",isElementExist(text_replay));
		}
		//回到列表页
		driver.navigate().back();
		waitForPageLoadComplete();
	}
	

	public void verifyDetail_Comment(String expectStatus) throws Exception {
		
			//重置清空搜索条件
			opsDataPage.btn_clear.click();
			Thread.sleep(1000);
			//过滤评论数据
			WebElement option_status = driver.findElement(By.xpath("//option[text()='"+expectStatus+"']"));
			option_status.click();
			opsDataPage.option_comment.click();
			opsDataPage.btn_search.click();
			waitForPageLoadComplete();
			
			String viewColumnNo = getNodeNo(opsDataPage.titles,"管理");
			List<WebElement> link_ComDetail = driver.findElements(By.xpath(".//*[@id='opdata-list']/tbody/tr/td["+viewColumnNo+"]"));
			
			//点击浏览打开已删除评论详情页面
			if(link_ComDetail.size()>0){
				//点击浏览链接
				link_ComDetail.get(0).click();
				waitForPageLoadComplete();
				waitForElementExist(form_commentFields);
				
				//验证状态是否正确
				String statusNo = getNodeNo(commentFields,"状态");
				WebElement statusValueIndetail = driver.findElement(By.xpath("//dl[@class='vertical-list']/dd["+statusNo+"]"));
				assertTrue("评论详情页状态不正确："+statusValueIndetail.getText(), statusValueIndetail.getText().contains(expectStatus));
				
				if(expectStatus.equals("未处理")){
					//验证回复框显示
					assertTrue("评论框不显示在未处理评论页中。",isElementExist(text_replay));
					//验证所有回复不显示
					assertFalse("回复内容显示在未处理评论页中。",isElementExist(text_AllReplay));
				}else if(expectStatus.equals("已回复")){
					//验证回复框显示
					assertTrue("评论框不显示在已回复评论页中。",isElementExist(text_replay));
					//验证所有回复显示
					assertTrue("回复内容未显示在已回复评论页中。",isElementExist(text_AllReplay));
				}
			}
			
			//回到列表页
			driver.navigate().back();
			waitForPageLoadComplete();
	}

}
